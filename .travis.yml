language: python
python:
  - "3.4"

stages:
  - test
  - deploy


jobs:
  include:
    - stage: test
      sudo: required
      services:
        - docker
      name: "Checking Production Container Run"
      script:
        - make check-docker-production

    - stage: test
      sudo: required
      services:
        - docker
      name: "Checking Development Container Run"
      script:
        - make check-docker-dev

    - stage: test
      virtualenv:
        system_site_packages: true
      cache: pip
      install:
        - pip install -r product_microservice/requirements/dev.txt
      name: "Unit Tests"
      script: sh run-tests.sh

    - stage: deploy
      name: "Deploying to Staging"
      before_deploy:
        - echo "-> Deploy :D"
        - cd product_microservice
      provider: heroku
      api_key:
        heroku/deploy-stg: $HEROKU_DEV_KEY
      app:
        heroku/deploy-stg: $HEROKU_APP